---
- name: Build and Push Docker image to Docker Hub
  hosts: "{{ HOST_IP }}"
  become: true
  gather_facts: false

  tasks:
    - name: Ensure Git is installed
      package:
        name: git
        state: present

    - name: Clone the repository
      git:
        repo: "{{ GIT_URL }}"
        dest: "/opt/java-app"

    - name: Log into DockerHub
      docker_login:
        username: "{{ DH_USERNAME }}"
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63633234333834323532623031366539616636646162363137663135316435396435343139613031
          6664623563663630373537353336656133613265313438370a646436343631643562306132373363
          62376363366538303565316134626331323163393437366335376131343366646161653430653032
          6530306331396534360a393931343339336334336461383239333235636431356361313365393066
          64333337303430373833636366616139613662313364383431363964653432663732

    - name: Build and Push Docker image to Docker Hub
      docker_image:
        name: "schedule-app"
        tag: "latest"
        repository: "{{ DH_REPO }}"
        build:
          path: "/opt/java-app"
        push: true
        force_tag: true
        source: build
